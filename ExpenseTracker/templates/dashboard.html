{% extends 'layout.html' %}

{% block content %}
<h2 class="mb-4">Expense Dashboard</h2>

<div class="row">
    <div class="col-md-4 mb-4">
        <div class="card text-center h-100 shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Total Spent</h5>
                <div class="display-4 mb-3">{{ total_spent|currency }}</div>
                <p class="card-text text-muted">
                    Across {{ expenses|length }} total expenses
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-md-8 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">Expenses by Category</h5>
                <div class="chart-container" style="position: relative; height:250px;">
                    <canvas id="categoryPieChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Category Breakdown</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>% of Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for category, amount in category_spending.items() %}
                            <tr>
                                <td>
                                    {% set category_icons = {
                                        'food': 'utensils',
                                        'transportation': 'car',
                                        'entertainment': 'film',
                                        'utilities': 'bolt',
                                        'housing': 'home',
                                        'healthcare': 'heartbeat',
                                        'shopping': 'shopping-bag',
                                        'education': 'graduation-cap',
                                        'personal': 'user',
                                        'travel': 'plane',
                                        'other': 'tag'
                                    } %}
                                    <i class="fas fa-{{ category_icons.get(category, 'tag') }} me-2"></i>
                                    {{ category|capitalize }}
                                </td>
                                <td>{{ amount|currency }}</td>
                                <td>
                                    {% if total_spent > 0 %}
                                        {{ "%.1f"|format((amount / total_spent) * 100) }}%
                                    {% else %}
                                        0%
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Budgets -->
<div class="row mt-4">
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title d-flex justify-content-between align-items-center">Budgets
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addBudgetModal">Add Budget</button>
                </h5>
                {% if budgets %}
                    {% for b in budgets %}
                        <div class="mb-3" id="budgetBlock{{ b.budget.id }}" data-budget-id="{{ b.budget.id }}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ b.budget.category|capitalize }}</strong>
                                    <div class="text-muted small"><span id="budgetAmounts{{ b.budget.id }}">{{ b.spent|currency }} / {{ b.available|currency }}</span></div>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#editBudgetModal{{ b.budget.id }}">Edit</button>
                                    <form method="POST" action="{{ url_for('delete_budget', budget_id=b.budget.id) }}" class="m-0">
                                        {{ budget_form.csrf_token }}
                                        <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                                    </form>
                                </div>
                            </div>
                            <div class="progress mt-2" style="height:14px;">
                                <div class="progress-bar" id="budgetProgress{{ b.budget.id }}" role="progressbar" style="width: {{ b.percent }}%;" aria-valuenow="{{ b.percent }}" aria-valuemin="0" aria-valuemax="100">{{ b.percent|round(0) }}%</div>
                            </div>
                        </div>

                        <!-- Edit Budget Modal -->
                        <div class="modal fade" id="editBudgetModal{{ b.budget.id }}" tabindex="-1" aria-hidden="true">
                          <div class="modal-dialog">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title">Edit Budget - {{ b.budget.category|capitalize }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                              </div>
                                                            <form method="POST" action="{{ url_for('edit_budget', budget_id=b.budget.id) }}" class="budget-edit-form" data-budget-id="{{ b.budget.id }}">
                              <div class="modal-body">
                                {{ budget_form.csrf_token }}
                                <div class="mb-3">
                                    <label class="form-label">Monthly amount</label>
                                    <input name="amount" class="form-control" value="{{ b.budget.amount }}" />
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="rollover" id="rollover{{ b.budget.id }}" {% if b.budget.rollover %}checked{% endif %} />
                                    <label class="form-check-label" for="rollover{{ b.budget.id }}">Allow rollover</label>
                                </div>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button class="btn btn-primary">Save</button>
                              </div>
                              </form>
                            </div>
                          </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No budgets set. Create one to track spending limits per category.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title d-flex justify-content-between align-items-center">Recurring Transactions
                    <div>
                        <button class="btn btn-sm btn-outline-success me-2" id="runRecurringBtn">Run Now</button>
                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addRecurringModal">Add</button>
                    </div>
                </h5>
                {% if recurring %}
                    <ul class="list-group">
                        {% for r in recurring %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ r.category|capitalize }}</strong> — {{ r.description or 'Recurring' }}
                                    <div class="text-muted small">Amount: {{ r.amount|currency }} · Day: {{ r.day_of_month }}</div>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#editRecurringModal{{ r.id }}">Edit</button>
                                    <form method="POST" action="{{ url_for('delete_recurring', rec_id=r.id) }}" class="m-0">
                                        {{ recurring_form.csrf_token }}
                                        <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                                    </form>
                                </div>
                            </li>

                            <!-- Edit Recurring Modal -->
                            <div class="modal fade" id="editRecurringModal{{ r.id }}" tabindex="-1" aria-hidden="true">
                              <div class="modal-dialog">
                                <div class="modal-content">
                                  <div class="modal-header">
                                    <h5 class="modal-title">Edit Recurring - {{ r.category|capitalize }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                  </div>
                                  <form method="POST" action="{{ url_for('edit_recurring', rec_id=r.id) }}">
                                  <div class="modal-body">
                                    {{ recurring_form.csrf_token }}
                                    <div class="mb-3"><label class="form-label">Amount</label><input name="amount" class="form-control" value="{{ r.amount }}" /></div>
                                    <div class="mb-3"><label class="form-label">Description</label><input name="description" class="form-control" value="{{ r.description }}" /></div>
                                    <div class="mb-3"><label class="form-label">Day of month</label><input name="day_of_month" class="form-control" value="{{ r.day_of_month }}" /></div>
                                    <div class="form-check"><input type="checkbox" class="form-check-input" id="active{{ r.id }}" name="active" {% if r.active %}checked{% endif %}><label class="form-check-label" for="active{{ r.id }}">Active</label></div>
                                  </div>
                                  <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button class="btn btn-primary">Save</button>
                                  </div>
                                  </form>
                                </div>
                              </div>
                            </div>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">No recurring transactions set.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Savings Goals -->
<div class="row mt-3">
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title d-flex justify-content-between align-items-center">Savings Goals
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addGoalModal">New Goal</button>
                </h5>
                {% if goals %}
                    {% for g in goals %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ g.name }}</strong>
                                    <div class="text-muted small">{{ g.current_amount|currency }} / {{ g.target_amount|currency }}</div>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#editGoalModal{{ g.id }}">Edit</button>
                                    <form method="POST" action="{{ url_for('delete_goal', goal_id=g.id) }}" class="m-0">
                                        {{ goal_form.csrf_token }}
                                        <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                                    </form>
                                </div>
                            </div>
                            <div class="progress mt-2" style="height:12px;">
                                <div class="progress-bar bg-info" role="progressbar" style="width: {{ g.progress_percent() }}%;" aria-valuenow="{{ g.progress_percent() }}" aria-valuemin="0" aria-valuemax="100">{{ g.progress_percent()|round(0) }}%</div>
                            </div>
                            <div class="mt-2">
                                <form method="POST" action="{{ url_for('contribute_goal', goal_id=g.id) }}" class="row g-2">
                                    {{ contribution_form.csrf_token }}
                                    <div class="col-7">
                                        {{ contribution_form.amount(class='form-control', placeholder='Amount') }}
                                    </div>
                                    <div class="col-5 d-grid">
                                        <button class="btn btn-sm btn-outline-success">Add</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Edit Goal Modal -->
                        <div class="modal fade" id="editGoalModal{{ g.id }}" tabindex="-1" aria-hidden="true">
                          <div class="modal-dialog">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title">Edit Goal - {{ g.name }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                              </div>
                              <form method="POST" action="{{ url_for('edit_goal', goal_id=g.id) }}">
                              <div class="modal-body">
                                {{ goal_form.csrf_token }}
                                <div class="mb-3"><label class="form-label">Name</label><input name="name" class="form-control" value="{{ g.name }}" /></div>
                                <div class="mb-3"><label class="form-label">Target amount</label><input name="target_amount" class="form-control" value="{{ g.target_amount }}" /></div>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button class="btn btn-primary">Save</button>
                              </div>
                              </form>
                            </div>
                          </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No goals yet. Create a goal and start contributing.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Add Budget Modal -->
<div class="modal fade" id="addBudgetModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Budget</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('add_budget') }}">
      <div class="modal-body">
        {{ budget_form.csrf_token }}
        <div class="mb-3">{{ budget_form.category(class='form-select') }}</div>
        <div class="mb-3">{{ budget_form.amount(class='form-control', placeholder='Monthly amount') }}</div>
        <div class="form-check">{{ budget_form.rollover(class='form-check-input') }} <label class="form-check-label">Allow rollover</label></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary">Save</button>
      </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Recurring Modal -->
<div class="modal fade" id="addRecurringModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Recurring Transaction</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('add_recurring') }}">
      <div class="modal-body">
        {{ recurring_form.csrf_token }}
        <div class="mb-3">{{ recurring_form.amount(class='form-control', placeholder='Amount') }}</div>
        <div class="mb-3">{{ recurring_form.category(class='form-select') }}</div>
        <div class="mb-3">{{ recurring_form.description(class='form-control', placeholder='Description') }}</div>
        <div class="mb-3">{{ recurring_form.day_of_month(class='form-select') }}</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary">Save</button>
      </div>
      </form>
    </div>
  </div>
</div>

<!-- Add Goal Modal -->
<div class="modal fade" id="addGoalModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create Savings Goal</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="{{ url_for('create_goal') }}">
      <div class="modal-body">
        {{ goal_form.csrf_token }}
        <div class="mb-3">{{ goal_form.name(class='form-control', placeholder='Goal name') }}</div>
        <div class="mb-3">{{ goal_form.target_amount(class='form-control', placeholder='Target amount') }}</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary">Create</button>
      </div>
      </form>
    </div>
  </div>
</div>

{% if expenses %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Recent Expenses</h5>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for expense in expenses[:5] %}
                            <tr>
                                <td>{{ expense.date.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    {% set category_icons = {
                                        'food': 'utensils',
                                        'transportation': 'car',
                                        'entertainment': 'film',
                                        'utilities': 'bolt',
                                        'housing': 'home',
                                        'healthcare': 'heartbeat',
                                        'shopping': 'shopping-bag',
                                        'education': 'graduation-cap',
                                        'personal': 'user',
                                        'travel': 'plane',
                                        'other': 'tag'
                                    } %}
                                    <i class="fas fa-{{ category_icons.get(expense.category, 'tag') }} me-2"></i>
                                    {{ expense.category|capitalize }}
                                </td>
                                <td>{{ expense.description }}</td>
                                <td>{{ expense.amount|currency }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/chart.js') }}"></script>
<script src="{{ url_for('static', filename='js/budgets_ajax.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('runRecurringBtn');
    if (btn) {
        btn.addEventListener('click', function() {
            fetch('{{ url_for('run_recurring') }}', { method: 'POST', headers: {'Content-Type': 'application/json'} })
                .then(() => location.reload())
                .catch(err => { console.error(err); alert('Failed to run recurring'); });
        });
    }
});
</script>
{% endblock %}
